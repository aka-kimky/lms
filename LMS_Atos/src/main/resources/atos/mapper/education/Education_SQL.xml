<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="education">

	<sql id="whereClause">
	    <trim prefix="WHERE" prefixOverrides="AND">
	        AND a.STATUS != '1005'
	        <if test="statusCode != null and statusCode != ''">
	            AND a.STATUS = #{statusCode}
	        </if>
	        <if test="searchCnd == '0'">
	            AND a.TITLE LIKE CONCAT('%', #{searchWrd}, '%')  <!-- 교육명으로 검색 -->
	        </if>
	        <if test="searchCnd == '1'">
	            AND (c.MAIN_NAME LIKE CONCAT('%', #{searchWrd}, '%')
	            OR c.SUB_NAME LIKE CONCAT('%', #{searchWrd}, '%')
	            OR c.DETAIL_NAME LIKE CONCAT('%', #{searchWrd}, '%'))  <!-- 교육분류로 검색 -->
	        </if>
	    </trim>
	</sql>


<!-- 교육 과정 리스트 조회 -->
	<select id="selectEducationList" parameterType="atos.lms.education.service.EducationVO" resultType="atos.lms.education.service.EducationVO">
	    SELECT
	        a.EDU_CODE,
	        a.TITLE,
	        a.STATUS AS statusCode,
	        s.NAME AS statusName,  <!-- 상태 명칭 -->
	        c.MAIN_NAME,  <!-- 대분류 명칭 -->
	        c.SUB_NAME,   <!-- 중분류 명칭 -->
	        c.DETAIL_NAME,  <!-- 소분류 명칭 -->
	        c.CODE,  <!-- 분류 코드 -->
	        a.TRAINING_TIME,  <!-- 교육 시간 코드 -->
	        t.NAME AS trainingTimeName  <!-- 교육 시간 이름 추가 -->
	    FROM
	        ATOS_EDUCATION a
	    JOIN
	        ATOS_STATUS s ON a.STATUS = s.CODE  <!-- 상태 코드와 명칭 매핑 -->
	    JOIN
	        ATOS_CATEGORY c ON a.CATEGORY = c.CODE  <!-- 교육 분류 코드와 명칭 매핑 -->
	    LEFT JOIN
	        ATOS_TRAINING_TIME t ON a.TRAINING_TIME = t.CODE  <!-- 교육 시간 코드와 이름 매핑 -->
	    <include refid="whereClause" />
	    ORDER BY a.EDU_CODE DESC
	    LIMIT #{recordCountPerPage} OFFSET #{firstIndex}
	</select>

<!-- 교육 과정 총 개수 조회 -->
    <select id="selectEducationListCnt" parameterType="atos.lms.education.service.EducationVO" resultType="int">
        SELECT
            COUNT(a.EDU_CODE)
        FROM
            ATOS_EDUCATION a
        <include refid="whereClause" />
    </select>

<!-- 상태 코드 조회 -->
    <select id="selectStatusCode" resultType="atos.lms.education.service.EducationMasterVO">
        SELECT
            CODE AS statusCode,
            NAME AS statusName
        FROM
            ATOS_STATUS
        WHERE CODE IN ('1001', '1002', '1003', '1004')
    </select>
	
<!-- 상태 업데이트 쿼리 -->
	 <update id="updateStatus">
	    UPDATE ATOS_EDUCATION
	    SET STATUS = #{statusCode}
	    WHERE EDU_CODE IN
	    <foreach item="eduCode" collection="eduCodeList" open="(" separator="," close=")">
	        #{eduCode}
	    </foreach>
	 </update>
	
<!-- 교육 과정 등록 -->
	<insert id="insertEducation" parameterType="atos.lms.education.service.EducationVO">
	    INSERT INTO ATOS_EDUCATION(
	        TITLE, 
	        CATEGORY, 
	        DESCRIPTION,
	        OBJECTIVE, 
	        COMPLETION_CRITERIA, 
	        NOTE, 
	        STATUS,
	        TRAINING_TIME  <!-- 추가된 필드 -->
	    )
	    VALUES(
	        #{title}, 
	        #{category}, 
	        #{description}, 
	        #{objective}, 
	        #{completionCriteria},
	        #{note}, 
	        '1002',  <!-- 상태는 기본값으로 1002 설정 -->
	        #{trainingTime}  <!-- 추가된 필드에 대한 값 -->
	    )
	</insert>
    
    
    
	<select id="selectAllCategoryList" resultType="atos.lms.education.service.EducationVO">
	    SELECT 
	        CODE,  <!-- CODE 추가 -->
	        MAIN_CODE, MAIN_NAME, 
	        SUB_CODE, SUB_NAME, 
	        DETAIL_CODE, DETAIL_NAME 
	    FROM ATOS_CATEGORY
	    ORDER BY MAIN_CODE, SUB_CODE, DETAIL_CODE
	</select>


	<select id="selectTrainingTimeList" resultType="map">
	    SELECT
	        CODE AS value,
	        NAME AS label
	    FROM
	        ATOS_TRAINING_TIME
	    ORDER BY
	        CODE ASC
	</select>

    
<!-- 수료 조건 조회 쿼리 추가 -->
	<select id="selectCompletionCriteria" resultType="atos.lms.education.service.EducationMasterVO">
	    SELECT
	        CODE AS completionCode,
	        RATE AS completionRate,
	        SCORE AS completionScore,
	        SURVEY AS completionSurvey
	    FROM
	        ATOS_COMPLETION_CRITERIA
	</select>

</mapper>